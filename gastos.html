<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinCore ¬∑ Gastos Personales</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--bg:#020408;--surface:rgba(0,20,40,0.75);--border:rgba(0,200,255,0.13);--text:#c8e8ff;--muted:rgba(150,200,230,0.5);--cyan:#00f0ff;--green:#00ff88;--red:#ff3d6e;--yellow:#ffee00;--orange:#ff9500;--purple:#bf00ff;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100vh;overflow-x:hidden;}
#bgCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;}
.scanlines{position:fixed;inset:0;z-index:1;pointer-events:none;background:repeating-linear-gradient(to bottom,transparent 0,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);}
.app{position:relative;z-index:2;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:rgba(0,240,255,.3);border-radius:2px;}

/* NAV */
nav{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid var(--border);background:rgba(2,4,8,.92);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:10px;}
.logo{font-family:'Orbitron',monospace;font-size:1rem;font-weight:900;color:#fff;text-shadow:0 0 14px var(--cyan);}
.logo span{color:var(--cyan);}
.nav-tabs{display:flex;gap:4px;flex-wrap:wrap;}
.nav-tab{padding:5px 14px;border-radius:2px;border:1px solid transparent;background:transparent;color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.68rem;letter-spacing:.1em;cursor:pointer;text-transform:uppercase;transition:all .2s;}
.nav-tab.active,.nav-tab:hover{background:rgba(0,240,255,.1);border-color:rgba(0,240,255,.4);color:var(--cyan);}
.month-disp{font-family:'Orbitron',monospace;font-size:.85rem;color:var(--cyan);display:flex;align-items:center;gap:8px;}
.m-nav{background:none;border:1px solid rgba(0,240,255,.3);color:var(--cyan);cursor:pointer;padding:3px 10px;border-radius:2px;font-size:.8rem;transition:all .2s;}
.m-nav:hover{background:rgba(0,240,255,.12);}

/* MAIN */
.main{padding:20px 24px 60px;max-width:1400px;margin:0 auto;}
.page{display:none;}.page.active{display:block;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:4px;backdrop-filter:blur(10px);position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--ac,#00f0ff),transparent);opacity:.5;}
.card-head{padding:13px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-title{font-family:'Share Tech Mono',monospace;font-size:.63rem;color:var(--cyan);letter-spacing:.16em;text-transform:uppercase;}
.card-body{padding:16px 18px;}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:20px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px 16px;position:relative;}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--kc);box-shadow:0 0 8px var(--kc);}
.kpi-lbl{font-family:'Share Tech Mono',monospace;font-size:.56rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-bottom:5px;}
.kpi-val{font-family:'Orbitron',monospace;font-size:1.2rem;font-weight:700;color:var(--kc);text-shadow:0 0 10px var(--kc);}
.kpi-sub{font-size:.7rem;color:var(--muted);margin-top:3px;}

/* BUDGET BARS */
.budget-list{display:flex;flex-direction:column;gap:10px;}
.budget-item{cursor:default;}
.budget-row{display:flex;align-items:center;gap:10px;margin-bottom:4px;}
.budget-ico{font-size:1rem;width:24px;text-align:center;}
.budget-name{flex:1;font-size:.88rem;font-weight:500;}
.budget-vals{font-family:'Share Tech Mono',monospace;font-size:.65rem;text-align:right;white-space:nowrap;}
.budget-spent{color:var(--ac2);}
.budget-limit{color:var(--muted);}
.budget-track{height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;}
.budget-fill{height:100%;border-radius:3px;transition:width .5s ease;box-shadow:0 0 6px var(--ac2);}
.budget-pct{font-family:'Orbitron',monospace;font-size:.6rem;min-width:32px;text-align:right;}

/* FORM */
.add-form{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;align-items:end;}
.field label{display:block;font-family:'Share Tech Mono',monospace;font-size:.57rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:5px;}
.field input,.field select{width:100%;background:rgba(0,10,20,.8);border:1px solid var(--border);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.88rem;padding:8px 10px;border-radius:2px;outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus{border-color:var(--cyan);}
.field select option{background:#030912;}
.btn-add{padding:9px 18px;background:rgba(0,240,255,.08);border:1px solid var(--cyan);color:var(--cyan);font-family:'Share Tech Mono',monospace;font-size:.68rem;letter-spacing:.12em;text-transform:uppercase;border-radius:2px;cursor:pointer;transition:all .2s;width:100%;}
.btn-add:hover{background:rgba(0,240,255,.18);box-shadow:0 0 14px rgba(0,240,255,.25);}

/* EXPENSE LIST */
.exp-list{display:flex;flex-direction:column;gap:4px;max-height:420px;overflow-y:auto;}
.exp-item{display:flex;align-items:center;gap:12px;padding:9px 12px;border-radius:3px;border:1px solid transparent;transition:all .15s;background:rgba(255,255,255,.02);}
.exp-item:hover{background:rgba(0,240,255,.04);border-color:rgba(0,240,255,.12);}
.exp-ico{font-size:1rem;width:26px;text-align:center;}
.exp-info{flex:1;}
.exp-name{font-size:.88rem;font-weight:500;}
.exp-meta{font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--muted);margin-top:1px;}
.exp-cat-badge{display:inline-block;padding:1px 7px;border-radius:2px;font-family:'Share Tech Mono',monospace;font-size:.56rem;letter-spacing:.08em;}
.exp-amount{font-family:'Orbitron',monospace;font-size:.88rem;}
.exp-del{background:none;border:none;color:rgba(255,61,110,.3);cursor:pointer;font-size:.75rem;padding:2px 6px;transition:color .2s;}
.exp-del:hover{color:var(--red);}

/* CALENDAR HEATMAP */
.heat-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:6px;}
.heat-cell{aspect-ratio:1;border-radius:2px;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:.55rem;color:var(--muted);cursor:default;transition:all .2s;border:1px solid transparent;}
.heat-cell:hover{border-color:rgba(0,240,255,.3);}
.heat-label{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;}
.heat-label span{font-family:'Share Tech Mono',monospace;font-size:.52rem;color:var(--muted);text-align:center;letter-spacing:.05em;}

/* TREND CHART */
canvas{display:block;}

/* LAYOUT ROWS */
.row2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.row3{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;}
.row-full{margin-bottom:16px;}

/* GOAL ITEMS */
.goal-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(0,200,255,.06);}
.goal-item:last-child{border-bottom:none;}
.goal-info{flex:1;}
.goal-name{font-size:.88rem;font-weight:600;}
.goal-sub{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:1px;}
.goal-track{height:5px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;margin-top:6px;}
.goal-fill{height:100%;border-radius:3px;box-shadow:0 0 6px var(--gc);}
.goal-pct{font-family:'Orbitron',monospace;font-size:.75rem;color:var(--gc);min-width:40px;text-align:right;}

@media(max-width:700px){.row2,.row3{grid-template-columns:1fr;}}
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas>
<div class="scanlines"></div>
<div class="app">

<nav>
  <div class="logo">FIN<span>CORE</span> ¬∑ Gastos Personales</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('dashboard',this)">Dashboard</button>
    <button class="nav-tab" onclick="showPage('gastos',this)">Historial</button>
    <button class="nav-tab" onclick="showPage('presupuesto',this)">Presupuesto</button>
    <button class="nav-tab" onclick="showPage('metas',this)">Metas</button>
    <button class="nav-tab" onclick="showPage('nuevo',this)">+ A√±adir</button>
  </div>
  <div class="month-disp">
    <button class="m-nav" onclick="prevMonth()">‚óÄ</button>
    <span id="monthDisp"></span>
    <button class="m-nav" onclick="nextMonth()">‚ñ∂</button>
  </div>
</nav>

<div class="main">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="kpi-row" id="kpiRow"></div>
    <div class="row3">
      <div class="card" style="--ac:var(--cyan)">
        <div class="card-head"><div class="card-title">Gastos por d√≠a ¬∑ mes actual</div></div>
        <div class="card-body" style="padding:14px 18px"><canvas id="barDay" height="180"></canvas></div>
      </div>
      <div class="card" style="--ac:var(--purple)">
        <div class="card-head"><div class="card-title">Por categor√≠a</div></div>
        <div class="card-body">
          <canvas id="donutCat" height="150" style="display:block;margin:0 auto;"></canvas>
          <div id="donutLeg" style="margin-top:10px;display:flex;flex-direction:column;gap:5px;"></div>
        </div>
      </div>
    </div>
    <div class="row2">
      <div class="card" style="--ac:var(--orange)">
        <div class="card-head"><div class="card-title">Evoluci√≥n mensual ¬∑ 6 meses</div></div>
        <div class="card-body" style="padding:14px 18px"><canvas id="trendChart" height="140"></canvas></div>
      </div>
      <div class="card" style="--ac:var(--green)">
        <div class="card-head"><div class="card-title">√öltimos gastos</div></div>
        <div class="card-body" style="padding:10px 14px"><div class="exp-list" id="lastExp"></div></div>
      </div>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="page" id="page-gastos">
    <div class="row-full" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
      <input style="background:rgba(0,10,20,.8);border:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.75rem;padding:8px 14px;border-radius:2px;outline:none;flex:1;min-width:200px;max-width:400px;" id="histSearch" placeholder="Buscar gasto..." oninput="renderHist()">
      <select style="background:rgba(0,10,20,.8);border:1px solid var(--border);color:var(--cyan);font-family:'Share Tech Mono',monospace;font-size:.72rem;padding:8px 12px;border-radius:2px;outline:none;" id="histCatFilter" onchange="renderHist()">
        <option value="">Todas las categor√≠as</option>
      </select>
    </div>
    <div class="card" style="--ac:var(--cyan)">
      <div class="card-head"><div class="card-title" id="histTitle">Historial de gastos</div></div>
      <div class="card-body" style="padding:10px 14px"><div class="exp-list" id="histList"></div></div>
    </div>
    <div class="row-full" style="margin-top:14px;">
      <div class="card" style="--ac:var(--cyan)">
        <div class="card-head"><div class="card-title">Mapa de calor ¬∑ gasto diario</div></div>
        <div class="card-body">
          <div class="heat-label"><span>L</span><span>M</span><span>X</span><span>J</span><span>V</span><span>S</span><span>D</span></div>
          <div class="heat-grid" id="heatGrid"></div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:8px;font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--muted);">
            <span>MENOS</span>
            <div style="display:flex;gap:2px;">
              ${['rgba(0,240,255,.05)','rgba(0,240,255,.2)','rgba(0,240,255,.4)','rgba(0,240,255,.65)','rgba(0,240,255,.9)'].map(c=>`<div style="width:12px;height:12px;background:${c};border-radius:2px;"></div>`).join('')}
            </div>
            <span>M√ÅS</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRESUPUESTO -->
  <div class="page" id="page-presupuesto">
    <div class="row2">
      <div class="card" style="--ac:var(--cyan)">
        <div class="card-head">
          <div class="card-title">Presupuesto por categor√≠a</div>
          <span style="font-family:'Share Tech Mono',monospace;font-size:.62rem;color:var(--muted)" id="presupTotLbl"></span>
        </div>
        <div class="card-body"><div class="budget-list" id="budgetList"></div></div>
      </div>
      <div class="card" style="--ac:var(--yellow)">
        <div class="card-head"><div class="card-title">Ajustar presupuestos</div></div>
        <div class="card-body" id="budgetEditPanel"></div>
      </div>
    </div>
  </div>

  <!-- METAS -->
  <div class="page" id="page-metas">
    <div class="row2">
      <div class="card" style="--ac:var(--green)">
        <div class="card-head"><div class="card-title">Metas de ahorro</div></div>
        <div class="card-body" id="goalsList"></div>
      </div>
      <div class="card" style="--ac:var(--purple)">
        <div class="card-head"><div class="card-title">Nueva meta</div></div>
        <div class="card-body">
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div class="field"><label>Nombre</label><input id="gName" type="text" placeholder="Vacaciones, emergencia..."></div>
            <div class="field"><label>Objetivo ‚Ç¨</label><input id="gTarget" type="number" placeholder="5000"></div>
            <div class="field"><label>Ahorrado ‚Ç¨</label><input id="gSaved" type="number" placeholder="1200"></div>
            <div class="field"><label>Color</label>
              <select id="gColor"><option value="#00ff88">Verde</option><option value="#00f0ff">Cyan</option><option value="#ffee00">Amarillo</option><option value="#bf00ff">P√∫rpura</option><option value="#ff9500">Naranja</option></select></div>
            <button class="btn-add" onclick="addGoal()">‚ñ∏ CREAR META</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NUEVO GASTO -->
  <div class="page" id="page-nuevo">
    <div class="card" style="--ac:var(--cyan);margin-bottom:16px;">
      <div class="card-head"><div class="card-title">Registrar gasto</div></div>
      <div class="card-body">
        <div class="add-form">
          <div class="field"><label>Concepto</label><input id="nConcepto" type="text" placeholder="¬øEn qu√©?"></div>
          <div class="field"><label>Importe ‚Ç¨</label><input id="nImporte" type="number" placeholder="0.00" step="0.01"></div>
          <div class="field"><label>Categor√≠a</label>
            <select id="nCat" onchange="updateCatIco()">
              <option value="Vivienda">üè† Vivienda</option>
              <option value="Alimentaci√≥n">üõí Alimentaci√≥n</option>
              <option value="Transporte">üöó Transporte</option>
              <option value="Salud">üíä Salud</option>
              <option value="Ocio">üéÆ Ocio</option>
              <option value="Ropa">üëó Ropa</option>
              <option value="Restaurantes">üçΩÔ∏è Restaurantes</option>
              <option value="Suscripciones">üì± Suscripciones</option>
              <option value="Educaci√≥n">üìö Educaci√≥n</option>
              <option value="Viajes">‚úàÔ∏è Viajes</option>
              <option value="Ahorro">üí∞ Ahorro</option>
              <option value="Otros">üì¶ Otros</option>
            </select></div>
          <div class="field"><label>Fecha</label><input id="nFecha" type="date"></div>
          <div class="field"><label>Nota (opcional)</label><input id="nNota" type="text" placeholder="Detalles..."></div>
          <div class="field"><label>&nbsp;</label><button class="btn-add" onclick="addGasto()">‚ñ∏ REGISTRAR</button></div>
        </div>
      </div>
    </div>
    <div class="card" style="--ac:var(--green)">
      <div class="card-head"><div class="card-title">√öltimos registros</div></div>
      <div class="card-body" style="padding:10px 14px"><div class="exp-list" id="nuevoRecent"></div></div>
    </div>
  </div>

</div>
</div>

<script>
/* BG */
(function(){
  const cv=document.getElementById('bgCanvas'),ctx=cv.getContext('2d');
  let W,H;const rs=()=>{W=cv.width=window.innerWidth;H=cv.height=window.innerHeight;};rs();window.addEventListener('resize',rs);
  const pts=Array.from({length:65},()=>({x:Math.random()*9999,y:Math.random()*9999,vx:(Math.random()-.5)*.28,vy:(Math.random()-.5)*.28,r:Math.random()*1.3+.3,c:['#00f0ff','#00ff88','#bf00ff','#ff9500'][Math.floor(Math.random()*4)]}));
  const orbs=Array.from({length:3},()=>({x:Math.random()*9999,y:Math.random()*9999,r:160+Math.random()*180,vx:(Math.random()-.5)*.38,vy:(Math.random()-.5)*.38,c:['0,240,255','0,255,136','191,0,255'][Math.floor(Math.random()*3)]}));
  function draw(){
    ctx.clearRect(0,0,W,H);
    orbs.forEach(o=>{o.x+=o.vx;o.y+=o.vy;if(o.x<-o.r)o.x=W+o.r;if(o.x>W+o.r)o.x=-o.r;if(o.y<-o.r)o.y=H+o.r;if(o.y>H+o.r)o.y=-o.r;const g=ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r);g.addColorStop(0,`rgba(${o.c},.04)`);g.addColorStop(1,`rgba(${o.c},0)`);ctx.fillStyle=g;ctx.beginPath();ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill();});
    ctx.strokeStyle='rgba(0,240,255,.022)';ctx.lineWidth=1;
    for(let x=0;x<W;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=0;y<H;y+=80){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    pts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=p.c;ctx.globalAlpha=.3;ctx.fill();ctx.globalAlpha=1;});
    for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){const dx=pts[i].x-pts[j].x,dy=pts[i].y-pts[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<80){ctx.strokeStyle=`rgba(0,240,255,${(1-d/80)*.05})`;ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pts[i].x,pts[i].y);ctx.lineTo(pts[j].x,pts[j].y);ctx.stroke();}}
    requestAnimationFrame(draw);}draw();
})();

/* CONSTANTS */
const CATS={
  'Vivienda':{ico:'üè†',color:'#4fc3f7',budget:900},
  'Alimentaci√≥n':{ico:'üõí',color:'#00ff88',budget:400},
  'Transporte':{ico:'üöó',color:'#ffee00',budget:200},
  'Salud':{ico:'üíä',color:'#ff6e96',budget:150},
  'Ocio':{ico:'üéÆ',color:'#bf00ff',budget:200},
  'Ropa':{ico:'üëó',color:'#ff9500',budget:120},
  'Restaurantes':{ico:'üçΩÔ∏è',color:'#ff3d6e',budget:180},
  'Suscripciones':{ico:'üì±',color:'#00f0ff',budget:80},
  'Educaci√≥n':{ico:'üìö',color:'#69f0ae',budget:100},
  'Viajes':{ico:'‚úàÔ∏è',color:'#ffd54f',budget:300},
  'Ahorro':{ico:'üí∞',color:'#00ff88',budget:500},
  'Otros':{ico:'üì¶',color:'#7d8590',budget:100},
};

function fmt(n){return n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨';}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function randF(a,b){return Math.random()*(b-a)+a;}

/* MONTHS */
const MONTH_NAMES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let curYear=new Date().getFullYear(), curMonth=new Date().getMonth();
function prevMonth(){curMonth--;if(curMonth<0){curMonth=11;curYear--;}updateAll();}
function nextMonth(){curMonth++;if(curMonth>11){curMonth=0;curYear++;}updateAll();}

/* GENERATE SAMPLE DATA */
function genGastos(){
  const gastos=[];
  const catKeys=Object.keys(CATS);
  for(let m=0;m<6;m++){
    const mIdx=(new Date().getMonth()-5+m+12)%12;
    const yr=mIdx>(new Date().getMonth())?curYear-1:curYear;
    const days=new Date(yr,mIdx+1,0).getDate();
    const n=rand(12,22);
    for(let i=0;i<n;i++){
      const cat=catKeys[rand(0,catKeys.length-1)];
      const day=rand(1,days);
      const date=`${yr}-${String(mIdx+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      gastos.push({
        id:Date.now()+Math.random(),
        concepto:genNombre(cat),
        importe:parseFloat(randF(8,CATS[cat].budget*.7).toFixed(2)),
        cat,date,nota:'',
        month:mIdx,year:yr
      });
    }
  }
  return gastos.sort((a,b)=>b.date.localeCompare(a.date));
}

const NOMBRES={'Vivienda':['Alquiler piso','Electricidad','Agua','Gas','Comunidad','Internet'],'Alimentaci√≥n':['Mercadona','Lidl','Carnicer√≠a','Fruter√≠a','Supermercado DIA','Alcampo'],'Transporte':['Gasolina','Metro mensual','Taxi','Parking','Tolls A3','Aver√≠a taller'],'Salud':['Farmacia','M√©dico privado','Fisioterapeuta','Dentista','Vitaminas','√ìptica'],'Ocio':['Netflix','Steam juego','Concierto','Cine','Spotify','HBO Max'],'Ropa':['Zara','Pull & Bear','Zapatos','Abrigo invierno','Camisa trabajo','Mango'],'Restaurantes':['Restaurante italiano','Brunch domingo','Bar tapas','Sushi','Burger','Terraza'],'Suscripciones':['Spotify','ChatGPT Plus','iCloud','Amazon Prime','Adobe CC','Gym'],'Educaci√≥n':['Curso Udemy','Libro t√©cnico','Ingl√©s online','M√°ster m√≥dulo','Taller dise√±o','Certificaci√≥n'],'Viajes':['Hotel Sevilla','Vuelo Barcelona','Alquiler coche','Airbnb','AVE Madrid','Excursi√≥n'],'Ahorro':['Transferencia ahorro','Fondo emergencia','Plan pensiones','Inversi√≥n ETF'],'Otros':['Regalo cumplea√±os','Peluquer√≠a','Papeler√≠a','Donaci√≥n','Limpiadora','Varios']};
function genNombre(cat){const arr=NOMBRES[cat]||['Gasto'];return arr[rand(0,arr.length-1)];}

let gastos=genGastos();
let goals=[
  {name:'Fondo emergencia',target:10000,saved:6800,color:'#00ff88'},
  {name:'Vacaciones Jap√≥n',target:3500,saved:1200,color:'#ffee00'},
  {name:'MacBook nuevo',target:2200,saved:880,color:'#00f0ff'},
];

function getMonthGastos(m,y){return gastos.filter(g=>g.month===m&&g.year===y);}
function getCurGastos(){return getMonthGastos(curMonth,curYear);}

/* PAGE NAV */
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='presupuesto')renderPresupuesto();
  if(id==='metas')renderMetas();
  if(id==='gastos')renderHist();
  if(id==='nuevo')renderNuevoRecent();
}

function updateAll(){
  document.getElementById('monthDisp').textContent=MONTH_NAMES[curMonth]+' '+curYear;
  renderKPIs();renderBarDay();renderDonut();renderTrend();renderLastExp();
}

/* KPIs */
function renderKPIs(){
  const gs=getCurGastos();
  const total=gs.reduce((s,g)=>s+g.importe,0);
  const totalBudget=Object.values(CATS).reduce((s,c)=>s+c.budget,0);
  const bigger=gs.sort((a,b)=>b.importe-a.importe)[0];
  const topCat=Object.entries(gs.reduce((a,g)=>{a[g.cat]=(a[g.cat]||0)+g.importe;return a;},{})).sort((a,b)=>b[1]-a[1])[0]||['‚Äî',0];
  const pct=totalBudget>0?total/totalBudget*100:0;
  const kpis=[
    {lbl:'Total gastado',val:fmt(total),sub:MONTH_NAMES[curMonth],c:pct<80?'#00ff88':pct<100?'#ffee00':'#ff3d6e'},
    {lbl:'Presupuesto',val:fmt(totalBudget),sub:`${pct.toFixed(0)}% utilizado`,c:'#00f0ff'},
    {lbl:'Categor√≠a top',val:topCat[0],sub:fmt(topCat[1]),c:CATS[topCat[0]]?.color||'#7d8590'},
    {lbl:'Mayor gasto',val:bigger?fmt(bigger.importe):'‚Äî',sub:bigger?.concepto||'',c:'#ff9500'},
    {lbl:'Transacciones',val:gs.length+'',sub:'este mes',c:'#bf00ff'},
    {lbl:'Media diaria',val:fmt(total/new Date(curYear,curMonth+1,0).getDate()),sub:'por d√≠a',c:'#69f0ae'},
  ];
  document.getElementById('kpiRow').innerHTML=kpis.map(k=>`<div class="kpi" style="--kc:${k.c}"><div class="kpi-lbl">${k.lbl}</div><div class="kpi-val">${k.val}</div><div class="kpi-sub">${k.sub}</div></div>`).join('');
}

/* BAR DAY CHART */
function renderBarDay(){
  const cv=document.getElementById('barDay');const ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=cv.parentElement.clientWidth-2;const H=180;
  cv.style.width=W+'px';cv.style.height=H+'px';cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const days=new Date(curYear,curMonth+1,0).getDate();
  const byDay=Array(days).fill(0);
  getCurGastos().forEach(g=>{const d=parseInt(g.date.split('-')[2])-1;if(d>=0&&d<days)byDay[d]+=g.importe;});
  const maxV=Math.max(...byDay,1);
  const pad={t:16,r:10,b:28,l:52};
  const cW=W-pad.l-pad.r;const cH=H-pad.t-pad.b;
  // Grid
  ctx.strokeStyle='rgba(0,240,255,.06)';ctx.lineWidth=1;
  [0,.25,.5,.75,1].forEach(f=>{const y=pad.t+cH*(1-f);ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+cW,y);ctx.stroke();ctx.fillStyle='rgba(150,200,230,.4)';ctx.font='9px Share Tech Mono';ctx.textAlign='right';ctx.fillText((maxV*f).toFixed(0),pad.l-4,y+4);});
  const bW=Math.max(2,cW/days-1.5);
  byDay.forEach((v,i)=>{
    if(v===0)return;
    const x=pad.l+(i/days)*cW;const h=(v/maxV)*cH;
    const g2=ctx.createLinearGradient(0,pad.t+cH-h,0,pad.t+cH);
    g2.addColorStop(0,'rgba(0,240,255,.9)');g2.addColorStop(1,'rgba(0,240,255,.15)');
    ctx.fillStyle=g2;ctx.fillRect(x,pad.t+cH-h,bW,h);
    ctx.strokeStyle='rgba(0,240,255,.7)';ctx.lineWidth=.5;ctx.strokeRect(x,pad.t+cH-h,bW,h);
  });
  // Day labels
  ctx.fillStyle='rgba(150,200,230,.4)';ctx.font='8px Share Tech Mono';ctx.textAlign='center';
  [1,7,14,21,28].forEach(d=>{if(d<=days){const x=pad.l+((d-1)/days)*cW+bW/2;ctx.fillText(d,x,pad.t+cH+16);}});
}

/* DONUT */
function renderDonut(){
  const gs=getCurGastos();
  const byCat={};gs.forEach(g=>{byCat[g.cat]=(byCat[g.cat]||0)+g.importe;});
  const entries=Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,7);
  const total=entries.reduce((s,e)=>s+e[1],0)||1;
  const cv=document.getElementById('donutCat');const ctx=cv.getContext('2d');
  const SZ=140;const dpr=window.devicePixelRatio||1;
  cv.style.width=SZ+'px';cv.style.height=SZ+'px';cv.width=SZ*dpr;cv.height=SZ*dpr;ctx.scale(dpr,dpr);ctx.clearRect(0,0,SZ,SZ);
  let ang=-Math.PI/2;
  entries.forEach(([cat,val])=>{const sl=(val/total)*Math.PI*2;const col=CATS[cat]?.color||'#7d8590';ctx.beginPath();ctx.moveTo(SZ/2,SZ/2);ctx.arc(SZ/2,SZ/2,58,ang,ang+sl);ctx.closePath();ctx.fillStyle=col;ctx.globalAlpha=.85;ctx.fill();ctx.strokeStyle=col;ctx.globalAlpha=1;ctx.lineWidth=1;ctx.stroke();ang+=sl;});
  ctx.beginPath();ctx.arc(SZ/2,SZ/2,35,0,Math.PI*2);ctx.fillStyle='#020408';ctx.fill();ctx.strokeStyle='rgba(0,240,255,.2)';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='rgba(0,240,255,.8)';ctx.font='bold 10px Orbitron';ctx.textAlign='center';ctx.fillText(fmt(total).replace('‚Ç¨',''),SZ/2,SZ/2);ctx.font='8px Share Tech Mono';ctx.fillStyle='rgba(150,200,230,.5)';ctx.fillText('TOTAL',SZ/2,SZ/2+13);
  document.getElementById('donutLeg').innerHTML=entries.map(([cat,val])=>`<div style="display:flex;align-items:center;gap:7px;font-size:.78rem"><div style="width:7px;height:7px;border-radius:50%;background:${CATS[cat]?.color||'#7d8590'};box-shadow:0 0 4px ${CATS[cat]?.color||'#7d8590'};flex-shrink:0"></div><span style="flex:1;font-size:.78rem">${CATS[cat]?.ico} ${cat}</span><span style="font-family:'Orbitron',monospace;font-size:.68rem;color:${CATS[cat]?.color||'#7d8590'}">${fmt(val)}</span></div>`).join('');
}

/* TREND */
function renderTrend(){
  const cv=document.getElementById('trendChart');const ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=cv.parentElement.clientWidth-2;const H=140;
  cv.style.width=W+'px';cv.style.height=H+'px';cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const months=[];const totals=[];
  for(let i=5;i>=0;i--){const mIdx=(curMonth-i+12)%12;const yr=mIdx>curMonth?curYear-1:curYear;const t=getMonthGastos(mIdx,yr).reduce((s,g)=>s+g.importe,0);months.push(MONTH_NAMES[mIdx].slice(0,3));totals.push(t);}
  const maxV=Math.max(...totals,1);const pad={t:16,r:14,b:28,l:56};const cW=W-pad.l-pad.r;const cH=H-pad.t-pad.b;
  ctx.strokeStyle='rgba(0,240,255,.06)';ctx.lineWidth=1;
  [0,.5,1].forEach(f=>{const y=pad.t+cH*(1-f);ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+cW,y);ctx.stroke();ctx.fillStyle='rgba(150,200,230,.4)';ctx.font='9px Share Tech Mono';ctx.textAlign='right';ctx.fillText((maxV*f/1000).toFixed(1)+'k',pad.l-4,y+4);});
  const xS=i=>pad.l+i*(cW/5);const yS=v=>pad.t+cH*(1-v/maxV);
  // Area
  ctx.beginPath();ctx.moveTo(xS(0),yS(totals[0]));totals.forEach((v,i)=>{if(i>0)ctx.lineTo(xS(i),yS(v));});
  ctx.lineTo(xS(5),pad.t+cH);ctx.lineTo(xS(0),pad.t+cH);ctx.closePath();
  const gA=ctx.createLinearGradient(0,pad.t,0,pad.t+cH);gA.addColorStop(0,'rgba(255,149,0,.2)');gA.addColorStop(1,'rgba(255,149,0,.01)');ctx.fillStyle=gA;ctx.fill();
  // Line
  ctx.beginPath();ctx.moveTo(xS(0),yS(totals[0]));totals.forEach((v,i)=>{if(i>0)ctx.lineTo(xS(i),yS(v));});
  ctx.strokeStyle='rgba(255,149,0,.9)';ctx.lineWidth=2;ctx.stroke();
  // Points
  totals.forEach((v,i)=>{ctx.beginPath();ctx.arc(xS(i),yS(v),4,0,Math.PI*2);ctx.fillStyle='#ff9500';ctx.fill();ctx.strokeStyle='rgba(255,149,0,.5)';ctx.lineWidth=6;ctx.stroke();ctx.lineWidth=1;});
  // Labels
  ctx.fillStyle='rgba(150,200,230,.45)';ctx.font='9px Share Tech Mono';ctx.textAlign='center';
  months.forEach((m,i)=>ctx.fillText(m,xS(i),pad.t+cH+16));
}

/* EXPENSE HTML */
function expHTML(g,withDel=true){
  const c=CATS[g.cat]||{ico:'üì¶',color:'#7d8590'};
  return `<div class="exp-item">
    <div class="exp-ico">${c.ico}</div>
    <div class="exp-info">
      <div class="exp-name">${g.concepto}</div>
      <div class="exp-meta">${g.date} <span class="exp-cat-badge" style="background:${c.color}18;color:${c.color};border:1px solid ${c.color}30">${g.cat}</span>${g.nota?` ¬∑ ${g.nota}`:''}</div>
    </div>
    <div class="exp-amount" style="color:${c.color}">${fmt(g.importe)}</div>
    ${withDel?`<button class="exp-del" onclick="delGasto('${g.id}')">‚úï</button>`:''}
  </div>`;
}

function renderLastExp(){document.getElementById('lastExp').innerHTML=getCurGastos().slice(0,6).map(g=>expHTML(g,false)).join('')||'<div style="color:var(--muted);font-size:.8rem;padding:16px;text-align:center">Sin gastos este mes</div>';}

/* HIST */
function renderHist(){
  const q=(document.getElementById('histSearch')?.value||'').toLowerCase();
  const cf=document.getElementById('histCatFilter')?.value||'';
  // Populate filter
  const catSel=document.getElementById('histCatFilter');
  if(catSel.options.length<=1){Object.keys(CATS).forEach(c=>{const o=new Option(CATS[c].ico+' '+c,c);catSel.add(o);});}
  let all=[...gastos].filter(g=>g.year===curYear&&g.month===curMonth);
  if(q)all=all.filter(g=>g.concepto.toLowerCase().includes(q)||g.cat.toLowerCase().includes(q));
  if(cf)all=all.filter(g=>g.cat===cf);
  document.getElementById('histTitle').textContent=`${all.length} movimientos ¬∑ ${fmt(all.reduce((s,g)=>s+g.importe,0))}`;
  document.getElementById('histList').innerHTML=all.map(g=>expHTML(g)).join('')||'<div style="color:var(--muted);font-size:.8rem;padding:20px;text-align:center">Sin resultados</div>';
  renderHeatMap();
}

/* HEATMAP */
function renderHeatMap(){
  const days=new Date(curYear,curMonth+1,0).getDate();
  const byDay={};getCurGastos().forEach(g=>{const d=g.date.split('-')[2];byDay[d]=(byDay[d]||0)+g.importe;});
  const maxV=Math.max(...Object.values(byDay),1);
  const firstDow=(new Date(curYear,curMonth,1).getDay()+6)%7; // Mon=0
  const cells=[];
  for(let i=0;i<firstDow;i++)cells.push('<div></div>');
  for(let d=1;d<=days;d++){
    const ds=String(d).padStart(2,'0');const v=byDay[ds]||0;
    const i=Math.min(4,Math.floor((v/maxV)*5));
    const alphas=[.05,.2,.4,.65,.9];const a=alphas[i];
    const title=v>0?`D√≠a ${d}: ${fmt(v)}`:`D√≠a ${d}: sin gastos`;
    cells.push(`<div class="heat-cell" style="background:rgba(0,240,255,${a});${a>.35?'color:#000;':''}${a>.6?'box-shadow:0 0 6px rgba(0,240,255,'+a+');':''}" title="${title}">${d}</div>`);
  }
  document.getElementById('heatGrid').innerHTML=cells.join('');
}

/* PRESUPUESTO */
function renderPresupuesto(){
  const gs=getCurGastos();
  const byCat={};gs.forEach(g=>{byCat[g.cat]=(byCat[g.cat]||0)+g.importe;});
  const totalBud=Object.values(CATS).reduce((s,c)=>s+c.budget,0);
  const totalSpent=Object.values(byCat).reduce((s,v)=>s+v,0);
  document.getElementById('presupTotLbl').textContent=`${fmt(totalSpent)} / ${fmt(totalBud)}`;
  document.getElementById('budgetList').innerHTML=Object.entries(CATS).map(([cat,info])=>{
    const spent=byCat[cat]||0;const pct=Math.min(100,spent/info.budget*100);
    const col=pct<70?info.color:pct<90?'#ffee00':'#ff3d6e';
    return `<div class="budget-item" style="--ac2:${col}">
      <div class="budget-row">
        <div class="budget-ico">${info.ico}</div>
        <div class="budget-name">${cat}</div>
        <div class="budget-vals"><span class="budget-spent">${fmt(spent)}</span> <span class="budget-limit">/ ${fmt(info.budget)}</span></div>
        <div class="budget-pct" style="color:${col}">${pct.toFixed(0)}%</div>
      </div>
      <div class="budget-track"><div class="budget-fill" style="width:${pct}%;background:${col};box-shadow:0 0 6px ${col}"></div></div>
    </div>`;}).join('');
  document.getElementById('budgetEditPanel').innerHTML=Object.entries(CATS).map(([cat,info])=>`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <span style="width:22px;text-align:center">${info.ico}</span>
      <span style="flex:1;font-size:.82rem">${cat}</span>
      <input type="number" value="${info.budget}" style="width:80px;background:rgba(0,10,20,.8);border:1px solid var(--border);color:${info.color};font-family:'Orbitron',monospace;font-size:.75rem;padding:5px 8px;border-radius:2px;outline:none;text-align:right;" onchange="CATS['${cat}'].budget=parseInt(this.value)||0;renderPresupuesto();">
    </div>`).join('');
}

/* METAS */
function renderMetas(){
  document.getElementById('goalsList').innerHTML=goals.map((g,i)=>`
    <div class="goal-item" style="--gc:${g.color}">
      <div class="goal-info">
        <div class="goal-name">${g.name}</div>
        <div class="goal-sub">${fmt(g.saved)} ahorrado de ${fmt(g.target)}</div>
        <div class="goal-track"><div class="goal-fill" style="width:${Math.min(100,g.saved/g.target*100).toFixed(1)}%;background:${g.color}"></div></div>
      </div>
      <div class="goal-pct">${(g.saved/g.target*100).toFixed(0)}%</div>
      <button style="background:none;border:1px solid rgba(0,240,255,.2);color:var(--cyan);padding:4px 10px;border-radius:2px;cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:.6rem;margin-left:8px;" onclick="addSaving(${i})">+‚Ç¨</button>
    </div>`).join('');
}
function addSaving(i){const a=parseFloat(prompt('¬øCu√°nto a√±adir?')||0);if(a>0){goals[i].saved=Math.min(goals[i].target,goals[i].saved+a);renderMetas();}}
function addGoal(){
  const name=document.getElementById('gName').value;const target=parseFloat(document.getElementById('gTarget').value)||0;const saved=parseFloat(document.getElementById('gSaved').value)||0;const color=document.getElementById('gColor').value;
  if(!name||!target){alert('Completa nombre y objetivo');return;}
  goals.push({name,target,saved,color});renderMetas();
  document.getElementById('gName').value='';document.getElementById('gTarget').value='';document.getElementById('gSaved').value='';
}

/* ADD GASTO */
function addGasto(){
  const concepto=document.getElementById('nConcepto').value||'Gasto';
  const importe=parseFloat(document.getElementById('nImporte').value)||0;
  const cat=document.getElementById('nCat').value;
  const date=document.getElementById('nFecha').value;
  const nota=document.getElementById('nNota').value;
  if(!date||importe===0){alert('Completa fecha e importe');return;}
  const g={id:Date.now()+Math.random(),concepto,importe,cat,date,nota,month:parseInt(date.split('-')[1])-1,year:parseInt(date.split('-')[0])};
  gastos.unshift(g);updateAll();renderNuevoRecent();
  document.getElementById('nConcepto').value='';document.getElementById('nImporte').value='';document.getElementById('nNota').value='';
}
function delGasto(id){gastos=gastos.filter(g=>String(g.id)!==String(id));updateAll();renderHist();}
function renderNuevoRecent(){document.getElementById('nuevoRecent').innerHTML=gastos.slice(0,8).map(g=>expHTML(g,false)).join('');}
function updateCatIco(){}

/* INIT */
document.getElementById('nFecha').valueAsDate=new Date();
updateAll();
window.addEventListener('resize',()=>{renderBarDay();renderTrend();});
</script>
</body>
</html>
