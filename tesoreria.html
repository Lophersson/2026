<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinCore ¬∑ Tesorer√≠a</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--bg:#020408;--surface:rgba(0,20,40,0.75);--border:rgba(0,200,255,0.13);--text:#c8e8ff;--muted:rgba(150,200,230,0.5);--cyan:#00f0ff;--green:#00ff88;--red:#ff3d6e;--yellow:#ffee00;--orange:#ff9500;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100vh;overflow-x:hidden;}
#bgCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;}
.scanlines{position:fixed;inset:0;z-index:1;pointer-events:none;background:repeating-linear-gradient(to bottom,transparent 0,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);}
.app{position:relative;z-index:2;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:rgba(0,240,255,.3);border-radius:2px;}

/* NAV */
nav{display:flex;align-items:center;justify-content:space-between;padding:16px 28px;border-bottom:1px solid var(--border);background:rgba(2,4,8,.9);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100;}
.logo{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:900;color:#fff;text-shadow:0 0 16px var(--cyan);}
.logo span{color:var(--cyan);}
.nav-tabs{display:flex;gap:4px;}
.nav-tab{padding:6px 16px;border-radius:2px;border:1px solid transparent;background:transparent;color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.7rem;letter-spacing:.1em;cursor:pointer;text-transform:uppercase;transition:all .2s;}
.nav-tab.active,.nav-tab:hover{background:rgba(0,240,255,.1);border-color:rgba(0,240,255,.4);color:var(--cyan);}
.saldo-display{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:700;text-shadow:0 0 14px var(--green);}

/* LAYOUT */
.main{padding:24px 28px 60px;max-width:1500px;margin:0 auto;}
.page{display:none;}.page.active{display:block;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;}
.row-full{margin-bottom:20px;}

/* CARD */
.card{background:var(--surface);border:1px solid var(--border);border-radius:4px;backdrop-filter:blur(10px);position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent,#00f0ff),transparent);opacity:.5;}
.card-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-title{font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--cyan);letter-spacing:.18em;text-transform:uppercase;}
.card-body{padding:18px 20px;}

/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px 18px;position:relative;}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--kc);box-shadow:0 0 8px var(--kc);}
.kpi-lbl{font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:6px;}
.kpi-val{font-family:'Orbitron',monospace;font-size:1.25rem;font-weight:700;color:var(--kc);text-shadow:0 0 10px var(--kc);}
.kpi-sub{font-size:.72rem;color:var(--muted);margin-top:3px;}

/* ALERT */
.alert-band{display:flex;align-items:center;gap:10px;padding:10px 18px;border-radius:3px;margin-bottom:14px;font-family:'Share Tech Mono',monospace;font-size:.7rem;letter-spacing:.08em;animation:alertPulse 2s ease-in-out infinite;}
.alert-band.red{background:rgba(255,61,110,.08);border:1px solid rgba(255,61,110,.3);color:#ff3d6e;}
.alert-band.yellow{background:rgba(255,238,0,.06);border:1px solid rgba(255,238,0,.25);color:var(--yellow);}
.alert-band.green{background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.2);color:var(--green);}
@keyframes alertPulse{0%,100%{opacity:1}50%{opacity:.75}}

/* TIMELINE CHART */
canvas{display:block;width:100%;}

/* VENCIMIENTOS LIST */
.venc-list{display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto;}
.venc-item{display:flex;align-items:center;gap:12px;padding:9px 14px;border-radius:3px;border:1px solid transparent;transition:all .15s;background:rgba(255,255,255,.02);}
.venc-item:hover{background:rgba(0,240,255,.04);border-color:rgba(0,240,255,.15);}
.venc-days{font-family:'Orbitron',monospace;font-size:.85rem;font-weight:700;min-width:36px;text-align:center;}
.venc-info{flex:1;}
.venc-name{font-size:.88rem;font-weight:500;}
.venc-date{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:1px;}
.venc-tipo{font-family:'Share Tech Mono',monospace;font-size:.6rem;padding:2px 8px;border-radius:2px;}
.venc-tipo.cobro{background:rgba(0,255,136,.1);color:var(--green);border:1px solid rgba(0,255,136,.2);}
.venc-tipo.pago{background:rgba(255,61,110,.1);color:var(--red);border:1px solid rgba(255,61,110,.2);}
.venc-imp{font-family:'Orbitron',monospace;font-size:.88rem;}

/* CUENTAS */
.cuenta-item{display:flex;align-items:center;gap:14px;padding:12px 14px;border-bottom:1px solid rgba(0,200,255,.07);}
.cuenta-item:last-child{border-bottom:none;}
.cuenta-ico{width:36px;height:36px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:1rem;background:rgba(0,240,255,.08);border:1px solid rgba(0,240,255,.15);}
.cuenta-name{flex:1;font-weight:600;font-size:.9rem;}
.cuenta-banco{font-family:'Share Tech Mono',monospace;font-size:.62rem;color:var(--muted);}
.cuenta-saldo{font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;}
.cuenta-badge{font-family:'Share Tech Mono',monospace;font-size:.55rem;padding:2px 8px;border-radius:2px;}

/* GAP INDICATOR */
.gap-bar-wrap{margin-top:8px;}
.gap-label{display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:.62rem;color:var(--muted);margin-bottom:5px;}
.gap-track{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;}
.gap-fill{height:100%;border-radius:3px;transition:width .4s ease;}

/* FORM */
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;align-items:end;}
.field label{display:block;font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:5px;}
.field input,.field select{width:100%;background:rgba(0,10,20,.8);border:1px solid var(--border);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.88rem;padding:8px 10px;border-radius:2px;outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus{border-color:var(--cyan);}
.field select option{background:#030912;}
.btn-add{padding:9px 20px;background:rgba(0,240,255,.08);border:1px solid var(--cyan);color:var(--cyan);font-family:'Share Tech Mono',monospace;font-size:.68rem;letter-spacing:.15em;text-transform:uppercase;border-radius:2px;cursor:pointer;transition:all .2s;width:100%;}
.btn-add:hover{background:rgba(0,240,255,.18);box-shadow:0 0 16px rgba(0,240,255,.25);}

/* WEEK GRID */
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px;}
.week-day{text-align:center;padding:10px 4px;border-radius:3px;border:1px solid rgba(0,200,255,.1);background:rgba(0,10,20,.4);}
.wd-name{font-family:'Share Tech Mono',monospace;font-size:.55rem;color:var(--muted);letter-spacing:.1em;margin-bottom:4px;}
.wd-date{font-family:'Orbitron',monospace;font-size:.75rem;color:var(--text);}
.wd-in{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--green);margin-top:4px;}
.wd-out{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--red);}
.wd-net{font-family:'Orbitron',monospace;font-size:.7rem;margin-top:4px;}
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas>
<div class="scanlines"></div>
<div class="app">

<nav>
  <div class="logo">FIN<span>CORE</span> ¬∑ Tesorer√≠a</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('dashboard',this)">Dashboard</button>
    <button class="nav-tab" onclick="showPage('vencimientos',this)">Vencimientos</button>
    <button class="nav-tab" onclick="showPage('cuentas',this)">Cuentas</button>
    <button class="nav-tab" onclick="showPage('nuevo',this)">+ A√±adir</button>
  </div>
  <div class="saldo-display" id="navSaldo"></div>
</nav>

<div class="main">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div id="alertBands"></div>
    <div class="kpi-row" id="kpiRow"></div>
    <div class="row-full card" style="--accent:var(--cyan)">
      <div class="card-head"><div class="card-title">Flujo de caja proyectado ¬∑ 90 d√≠as</div><span id="projLegend" style="display:flex;gap:16px;font-family:'Share Tech Mono',monospace;font-size:.62rem;"></span></div>
      <div class="card-body" style="padding:16px 20px 20px">
        <canvas id="flowChart" height="200"></canvas>
      </div>
    </div>
    <div class="row2">
      <div class="card" style="--accent:var(--green)">
        <div class="card-head"><div class="card-title">Pr√≥ximos cobros (30d)</div></div>
        <div class="card-body" style="padding:12px 16px"><div class="venc-list" id="nextCobros"></div></div>
      </div>
      <div class="card" style="--accent:var(--red)">
        <div class="card-head"><div class="card-title">Pr√≥ximos pagos (30d)</div></div>
        <div class="card-body" style="padding:12px 16px"><div class="venc-list" id="nextPagos"></div></div>
      </div>
    </div>
  </div>

  <!-- VENCIMIENTOS -->
  <div class="page" id="page-vencimientos">
    <div class="row2">
      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--cyan);letter-spacing:.18em;margin-bottom:12px;">‚óà COBROS PENDIENTES</div>
        <div class="venc-list" id="allCobros"></div>
      </div>
      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--red);letter-spacing:.18em;margin-bottom:12px;">‚óà PAGOS PENDIENTES</div>
        <div class="venc-list" id="allPagos"></div>
      </div>
    </div>
    <div class="row-full card" style="--accent:var(--yellow);margin-top:8px;">
      <div class="card-head"><div class="card-title">Semana actual ¬∑ vista de gaps</div></div>
      <div class="card-body"><div class="week-grid" id="weekGrid"></div></div>
    </div>
  </div>

  <!-- CUENTAS -->
  <div class="page" id="page-cuentas">
    <div class="row3">
      <div class="card" style="--accent:var(--cyan);grid-column:1/-1">
        <div class="card-head"><div class="card-title">Posici√≥n de tesorer√≠a consolidada</div></div>
        <div id="cuentasList"></div>
      </div>
    </div>
    <div class="row2">
      <div class="card" style="--accent:var(--green)">
        <div class="card-head"><div class="card-title">Distribuci√≥n por cuenta</div></div>
        <div class="card-body"><canvas id="cuentaDonut" height="160" style="display:block;margin:0 auto;"></canvas>
        <div id="cuentaLegend" style="margin-top:12px;display:flex;flex-direction:column;gap:6px;"></div></div>
      </div>
      <div class="card" style="--accent:var(--yellow)">
        <div class="card-head"><div class="card-title">Ratios de liquidez</div></div>
        <div class="card-body" id="ratioPanel"></div>
      </div>
    </div>
  </div>

  <!-- NUEVO -->
  <div class="page" id="page-nuevo">
    <div class="card" style="--accent:var(--cyan);margin-bottom:16px;">
      <div class="card-head"><div class="card-title">Registrar vencimiento</div></div>
      <div class="card-body">
        <div class="form-grid">
          <div class="field"><label>Tipo</label>
            <select id="vTipo"><option value="cobro">Cobro</option><option value="pago">Pago</option></select></div>
          <div class="field"><label>Concepto</label><input id="vConcepto" type="text" placeholder="Descripci√≥n..."></div>
          <div class="field"><label>Importe ‚Ç¨</label><input id="vImporte" type="number" placeholder="0.00" step="0.01"></div>
          <div class="field"><label>Fecha venc.</label><input id="vFecha" type="date"></div>
          <div class="field"><label>Cuenta</label>
            <select id="vCuenta"><option>Santander Operativa</option><option>BBVA Reservas</option><option>CaixaBank N√≥minas</option></select></div>
          <div class="field"><label>&nbsp;</label><button class="btn-add" onclick="addVenc()">‚ñ∏ REGISTRAR</button></div>
        </div>
      </div>
    </div>
    <div class="card" style="--accent:var(--green)">
      <div class="card-head"><div class="card-title">√öltimos registros</div></div>
      <div class="card-body" style="padding:12px 16px"><div class="venc-list" id="recentVenc"></div></div>
    </div>
  </div>

</div>
</div>

<script>
/* BG */
(function(){
  const cv=document.getElementById('bgCanvas'),ctx=cv.getContext('2d');
  let W,H;
  const rs=()=>{W=cv.width=window.innerWidth;H=cv.height=window.innerHeight;};rs();window.addEventListener('resize',rs);
  const pts=Array.from({length:70},()=>({x:Math.random()*9999,y:Math.random()*9999,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,r:Math.random()*1.2+.3,c:['#00f0ff','#00ff88','#ff3d6e','#ffee00'][Math.floor(Math.random()*4)]}));
  const orbs=Array.from({length:3},()=>({x:Math.random()*9999,y:Math.random()*9999,r:180+Math.random()*160,vx:(Math.random()-.5)*.35,vy:(Math.random()-.5)*.35,c:['0,240,255','0,255,136','255,149,0'][Math.floor(Math.random()*3)]}));
  function draw(){
    ctx.clearRect(0,0,W,H);
    orbs.forEach(o=>{o.x+=o.vx;o.y+=o.vy;if(o.x<-o.r)o.x=W+o.r;if(o.x>W+o.r)o.x=-o.r;if(o.y<-o.r)o.y=H+o.r;if(o.y>H+o.r)o.y=-o.r;const g=ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r);g.addColorStop(0,`rgba(${o.c},.04)`);g.addColorStop(1,`rgba(${o.c},0)`);ctx.fillStyle=g;ctx.beginPath();ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill();});
    ctx.strokeStyle='rgba(0,240,255,.022)';ctx.lineWidth=1;
    for(let x=0;x<W;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=0;y<H;y+=80){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    pts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=p.c;ctx.globalAlpha=.3;ctx.fill();ctx.globalAlpha=1;});
    for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){const dx=pts[i].x-pts[j].x,dy=pts[i].y-pts[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<80){ctx.strokeStyle=`rgba(0,240,255,${(1-d/80)*.05})`;ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pts[i].x,pts[i].y);ctx.lineTo(pts[j].x,pts[j].y);ctx.stroke();}}
    requestAnimationFrame(draw);
  }draw();
})();

/* DATA */
const today=new Date();
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function fmtDate(d){return d.toISOString().slice(0,10);}
function diffDays(ds){return Math.ceil((new Date(ds)-today)/(1000*60*60*24));}
function fmt(n){return n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨';}
function fmtK(n){return n>=1000?(n/1000).toFixed(1)+'k':n.toFixed(0);}

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

const CUENTAS=[
  {name:'Santander Operativa',banco:'Santander',ico:'üè¶',saldo:48320.50,color:'#00ff88'},
  {name:'BBVA Reservas',banco:'BBVA',ico:'üèõÔ∏è',saldo:22100.00,color:'#00f0ff'},
  {name:'CaixaBank N√≥minas',banco:'CaixaBank',ico:'üí≥',saldo:9870.30,color:'#ffee00'},
];

const cobrosBase=[
  {concepto:'Factura cliente Omega',importe:12400,days:rand(2,8)},
  {concepto:'Cobro proyecto web',importe:3200,days:rand(5,12)},
  {concepto:'Ingreso alquiler local',importe:1800,days:rand(1,5)},
  {concepto:'Liquidaci√≥n trimestral',importe:8750,days:rand(10,20)},
  {concepto:'Abono servicios tech',importe:2100,days:rand(15,25)},
  {concepto:'Factura #4421',importe:5600,days:rand(6,18)},
  {concepto:'Renovaci√≥n contrato',importe:9400,days:rand(20,40)},
  {concepto:'Cobro partial Alpha Corp',importe:4200,days:rand(30,50)},
];
const pagosBase=[
  {concepto:'N√≥minas personal',importe:18600,days:rand(1,6)},
  {concepto:'Alquiler oficina',importe:2400,days:rand(2,8)},
  {concepto:'Factura proveedor TK',importe:4100,days:rand(4,12)},
  {concepto:'Seguridad Social',importe:3200,days:rand(8,15)},
  {concepto:'IVA trimestral',importe:6800,days:rand(10,18)},
  {concepto:'Suministros energ√≠a',importe:780,days:rand(3,10)},
  {concepto:'Suscripci√≥n software',importe:340,days:rand(5,14)},
  {concepto:'Marketing digital',importe:1500,days:rand(12,22)},
  {concepto:'Seguros empresa',importe:1200,days:rand(20,35)},
];

let vencimientos=[
  ...cobrosBase.map((c,i)=>({...c,tipo:'cobro',fecha:fmtDate(addDays(today,c.days)),cuenta:CUENTAS[i%3].name})),
  ...pagosBase.map((p,i)=>({...p,tipo:'pago',fecha:fmtDate(addDays(today,p.days)),cuenta:CUENTAS[i%3].name})),
];
vencimientos.sort((a,b)=>a.fecha.localeCompare(b.fecha));

let userVenc=[];
function allVenc(){return [...vencimientos,...userVenc].sort((a,b)=>a.fecha.localeCompare(b.fecha));}

/* HELPERS */
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='vencimientos')renderVencPage();
  if(id==='cuentas')renderCuentasPage();
  if(id==='nuevo')renderRecentVenc();
}

function getSaldoTotal(){return CUENTAS.reduce((s,c)=>s+c.saldo,0);}

/* KPIs */
function renderKPIs(){
  const av=allVenc();
  const cobros30=av.filter(v=>v.tipo==='cobro'&&diffDays(v.fecha)<=30&&diffDays(v.fecha)>=0);
  const pagos30=av.filter(v=>v.tipo==='pago'&&diffDays(v.fecha)<=30&&diffDays(v.fecha)>=0);
  const totalC=cobros30.reduce((s,v)=>s+v.importe,0);
  const totalP=pagos30.reduce((s,v)=>s+v.importe,0);
  const saldo=getSaldoTotal();
  const gap=totalC-totalP;
  document.getElementById('navSaldo').textContent=fmt(saldo);
  document.getElementById('navSaldo').style.color=saldo>0?'#00ff88':'#ff3d6e';
  const kpis=[
    {lbl:'Saldo total',val:fmt(saldo),sub:'Todas las cuentas',c:'#00ff88'},
    {lbl:'Cobros 30 d√≠as',val:fmt(totalC),sub:cobros30.length+' vencimientos',c:'#00f0ff'},
    {lbl:'Pagos 30 d√≠as',val:fmt(totalP),sub:pagos30.length+' vencimientos',c:'#ff3d6e'},
    {lbl:'Gap de liquidez',val:fmt(gap),sub:gap>=0?'Posici√≥n positiva':'‚ö† D√©ficit',c:gap>=0?'#ffee00':'#ff3d6e'},
  ];
  document.getElementById('kpiRow').innerHTML=kpis.map(k=>`
    <div class="kpi" style="--kc:${k.c}">
      <div class="kpi-lbl">${k.lbl}</div>
      <div class="kpi-val">${k.val}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');
}

/* ALERTS */
function renderAlerts(){
  const av=allVenc();
  const urgente=av.filter(v=>v.tipo==='pago'&&diffDays(v.fecha)<=3&&diffDays(v.fecha)>=0);
  const cobros7=av.filter(v=>v.tipo==='cobro'&&diffDays(v.fecha)<=7&&diffDays(v.fecha)>=0);
  const saldo=getSaldoTotal();
  let html='';
  if(urgente.length>0)html+=`<div class="alert-band red">‚ö† ${urgente.length} pago${urgente.length>1?'s':''} vence${urgente.length===1?'':'n'} en los pr√≥ximos 3 d√≠as ‚Äî Total: ${fmt(urgente.reduce((s,v)=>s+v.importe,0))}</div>`;
  if(cobros7.length>0)html+=`<div class="alert-band green">‚úì ${cobros7.length} cobro${cobros7.length>1?'s':''} esperado${cobros7.length>1?'s':''} esta semana ‚Äî Total: ${fmt(cobros7.reduce((s,v)=>s+v.importe,0))}</div>`;
  if(saldo<20000)html+=`<div class="alert-band yellow">‚ö° Saldo consolidado bajo el umbral recomendado de 20.000‚Ç¨</div>`;
  document.getElementById('alertBands').innerHTML=html;
}

/* FLOW CHART */
function renderFlowChart(){
  const cv=document.getElementById('flowChart');
  const ctx=cv.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=cv.parentElement.clientWidth-0;
  const H=200;
  cv.style.width=W+'px';cv.style.height=H+'px';
  cv.width=W*dpr;cv.height=H*dpr;
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);

  // Build daily flow for 90 days
  const days=90;
  let saldo=getSaldoTotal();
  const saldos=[saldo];
  const cobrosLine=[];const pagosLine=[];
  const av=allVenc();
  for(let d=1;d<=days;d++){
    const ds=fmtDate(addDays(today,d));
    const c=av.filter(v=>v.tipo==='cobro'&&v.fecha===ds).reduce((s,v)=>s+v.importe,0);
    const p=av.filter(v=>v.tipo==='pago'&&v.fecha===ds).reduce((s,v)=>s+v.importe,0);
    cobrosLine.push(c);pagosLine.push(p);
    saldo+=c-p;saldos.push(saldo);
  }
  const allV=[...saldos].filter(Boolean);
  const minV=Math.min(...allV)*0.9;const maxV=Math.max(...allV)*1.05;
  const pad={t:20,r:20,b:30,l:64};
  const cW=W-pad.l-pad.r;const cH=H-pad.t-pad.b;
  const xScale=i=>pad.l+i*(cW/days);
  const yScale=v=>pad.t+cH*(1-(v-minV)/(maxV-minV));

  // Grid
  ctx.strokeStyle='rgba(0,240,255,.06)';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pad.t+cH*i/4;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+cW,y);ctx.stroke();
  ctx.fillStyle='rgba(150,200,230,.45)';ctx.font='9px Share Tech Mono';ctx.textAlign='right';
  ctx.fillText(fmtK(maxV-(maxV-minV)*i/4),pad.l-4,y+4);}
  // Week lines
  for(let d=7;d<=days;d+=7){const x=xScale(d);ctx.strokeStyle='rgba(0,240,255,.08)';ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,pad.t+cH);ctx.stroke();
  ctx.fillStyle='rgba(150,200,230,.35)';ctx.font='9px Share Tech Mono';ctx.textAlign='center';ctx.fillText('S'+(d/7),x,pad.t+cH+18);}

  // Area fill
  ctx.beginPath();ctx.moveTo(xScale(0),yScale(saldos[0]));
  saldos.forEach((v,i)=>{if(i>0)ctx.lineTo(xScale(i),yScale(v));});
  ctx.lineTo(xScale(days),pad.t+cH);ctx.lineTo(pad.l,pad.t+cH);ctx.closePath();
  const gFill=ctx.createLinearGradient(0,pad.t,0,pad.t+cH);
  gFill.addColorStop(0,'rgba(0,240,255,.15)');gFill.addColorStop(1,'rgba(0,240,255,.01)');
  ctx.fillStyle=gFill;ctx.fill();

  // Line
  ctx.beginPath();ctx.moveTo(xScale(0),yScale(saldos[0]));
  saldos.forEach((v,i)=>{if(i>0)ctx.lineTo(xScale(i),yScale(v));});
  ctx.strokeStyle='rgba(0,240,255,.9)';ctx.lineWidth=1.5;ctx.stroke();

  // Zero line if needed
  if(minV<0&&maxV>0){const y0=yScale(0);ctx.strokeStyle='rgba(255,61,110,.4)';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(pad.l,y0);ctx.lineTo(pad.l+cW,y0);ctx.stroke();ctx.setLineDash([]);}

  document.getElementById('projLegend').innerHTML=`
    <span style="color:#00f0ff">‚Äî SALDO PROYECTADO</span>
    <span style="color:rgba(255,61,110,.7)">- - L√çNEA CERO</span>`;
}

/* VENC ITEMS */
function vencHTML(v){
  const d=diffDays(v.fecha);
  const color=v.tipo==='cobro'?'#00ff88':'#ff3d6e';
  const urgColor=d<=3?'#ff3d6e':d<=7?'#ffee00':color;
  return `<div class="venc-item">
    <div class="venc-days" style="color:${urgColor};text-shadow:0 0 8px ${urgColor}">${d===0?'HOY':d+'d'}</div>
    <div class="venc-info">
      <div class="venc-name">${v.concepto}</div>
      <div class="venc-date">${v.fecha} ¬∑ ${v.cuenta}</div>
    </div>
    <span class="venc-tipo ${v.tipo}">${v.tipo}</span>
    <div class="venc-imp" style="color:${color}">${v.tipo==='cobro'?'+':'-'}${fmt(v.importe)}</div>
  </div>`;
}

/* NEXT 30D */
function renderNext30(){
  const av=allVenc();
  const cobros=av.filter(v=>v.tipo==='cobro'&&diffDays(v.fecha)>=0&&diffDays(v.fecha)<=30);
  const pagos=av.filter(v=>v.tipo==='pago'&&diffDays(v.fecha)>=0&&diffDays(v.fecha)<=30);
  document.getElementById('nextCobros').innerHTML=cobros.map(vencHTML).join('')||'<div style="color:var(--muted);font-size:.8rem;text-align:center;padding:20px">Sin cobros pr√≥ximos</div>';
  document.getElementById('nextPagos').innerHTML=pagos.map(vencHTML).join('')||'<div style="color:var(--muted);font-size:.8rem;text-align:center;padding:20px">Sin pagos pr√≥ximos</div>';
}

/* VENC PAGE */
function renderVencPage(){
  const av=allVenc();
  document.getElementById('allCobros').innerHTML=av.filter(v=>v.tipo==='cobro'&&diffDays(v.fecha)>=0).map(vencHTML).join('');
  document.getElementById('allPagos').innerHTML=av.filter(v=>v.tipo==='pago'&&diffDays(v.fecha)>=0).map(vencHTML).join('');
  renderWeekGrid();
}

/* WEEK GRID */
function renderWeekGrid(){
  const av=allVenc();
  const days=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  document.getElementById('weekGrid').innerHTML=Array.from({length:7},(_,i)=>{
    const d=addDays(today,i);const ds=fmtDate(d);
    const cob=av.filter(v=>v.tipo==='cobro'&&v.fecha===ds).reduce((s,v)=>s+v.importe,0);
    const pag=av.filter(v=>v.tipo==='pago'&&v.fecha===ds).reduce((s,v)=>s+v.importe,0);
    const net=cob-pag;const netC=net>=0?'#00ff88':'#ff3d6e';
    return `<div class="week-day">
      <div class="wd-name">${days[d.getDay()]}</div>
      <div class="wd-date">${d.getDate()}</div>
      ${cob>0?`<div class="wd-in">+${fmtK(cob)}</div>`:''}
      ${pag>0?`<div class="wd-out">-${fmtK(pag)}</div>`:''}
      ${(cob>0||pag>0)?`<div class="wd-net" style="color:${netC}">${net>=0?'+':''}${fmtK(net)}</div>`:'<div class="wd-net" style="color:var(--muted);font-size:.55rem">‚Äî</div>'}
    </div>`;}).join('');
}

/* CUENTAS PAGE */
function renderCuentasPage(){
  const total=CUENTAS.reduce((s,c)=>s+c.saldo,0);
  document.getElementById('cuentasList').innerHTML=CUENTAS.map(c=>`
    <div class="cuenta-item">
      <div class="cuenta-ico">${c.ico}</div>
      <div style="flex:1">
        <div class="cuenta-name">${c.name}</div>
        <div class="cuenta-banco">${c.banco}</div>
        <div class="gap-bar-wrap" style="margin-top:6px;">
          <div class="gap-track"><div class="gap-fill" style="width:${(c.saldo/total*100).toFixed(1)}%;background:${c.color};box-shadow:0 0 6px ${c.color}"></div></div>
        </div>
      </div>
      <div class="cuenta-saldo" style="color:${c.color};text-shadow:0 0 10px ${c.color}">${fmt(c.saldo)}</div>
      <span class="cuenta-badge" style="color:${c.color};border:1px solid ${c.color}33;background:${c.color}11;margin-left:12px">${(c.saldo/total*100).toFixed(0)}%</span>
    </div>`).join('');
  renderCuentaDonut();renderRatios();
}

function renderCuentaDonut(){
  const cv=document.getElementById('cuentaDonut');const ctx=cv.getContext('2d');
  const SIZE=150;const dpr=window.devicePixelRatio||1;
  cv.style.width=SIZE+'px';cv.style.height=SIZE+'px';cv.width=SIZE*dpr;cv.height=SIZE*dpr;ctx.scale(dpr,dpr);ctx.clearRect(0,0,SIZE,SIZE);
  const total=CUENTAS.reduce((s,c)=>s+c.saldo,0);let angle=-Math.PI/2;
  CUENTAS.forEach(c=>{const sl=(c.saldo/total)*Math.PI*2;ctx.beginPath();ctx.moveTo(SIZE/2,SIZE/2);ctx.arc(SIZE/2,SIZE/2,60,angle,angle+sl);ctx.closePath();ctx.fillStyle=c.color;ctx.globalAlpha=.85;ctx.fill();ctx.strokeStyle=c.color;ctx.globalAlpha=1;ctx.lineWidth=1;ctx.stroke();angle+=sl;});
  ctx.beginPath();ctx.arc(SIZE/2,SIZE/2,36,0,Math.PI*2);ctx.fillStyle='#020408';ctx.fill();ctx.strokeStyle='rgba(0,240,255,.2)';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='rgba(0,240,255,.8)';ctx.font='bold 11px Orbitron';ctx.textAlign='center';ctx.fillText(fmt(total/1000).replace('‚Ç¨','')+'k',SIZE/2,SIZE/2+4);
  document.getElementById('cuentaLegend').innerHTML=CUENTAS.map(c=>`<div style="display:flex;align-items:center;gap:8px;font-size:.82rem"><div style="width:8px;height:8px;border-radius:50%;background:${c.color};box-shadow:0 0 5px ${c.color}"></div><span style="flex:1">${c.name}</span><span style="font-family:'Orbitron',monospace;font-size:.75rem;color:${c.color}">${fmt(c.saldo)}</span></div>`).join('');
}

function renderRatios(){
  const total=getSaldoTotal();
  const av=allVenc();
  const pagos30=av.filter(v=>v.tipo==='pago'&&diffDays(v.fecha)>=0&&diffDays(v.fecha)<=30).reduce((s,v)=>s+v.importe,0);
  const ratio=pagos30>0?(total/pagos30):99;
  const ratios=[
    {lbl:'Ratio de cobertura',val:ratio.toFixed(2)+'x',desc:'Saldo / Pagos 30d',c:ratio>=2?'#00ff88':ratio>=1?'#ffee00':'#ff3d6e'},
    {lbl:'Liquidez inmediata',val:fmt(total),desc:'Disponible total',c:'#00f0ff'},
    {lbl:'D√≠as de cobertura',val:Math.round(total/(pagos30/30||1))+'d',desc:'A ritmo actual de pagos',c:'#ffee00'},
  ];
  document.getElementById('ratioPanel').innerHTML=ratios.map(r=>`
    <div style="margin-bottom:14px">
      <div style="font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--muted);letter-spacing:.12em;margin-bottom:4px">${r.lbl}</div>
      <div style="font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:700;color:${r.c};text-shadow:0 0 10px ${r.c}">${r.val}</div>
      <div style="font-size:.72rem;color:var(--muted)">${r.desc}</div>
      <div class="gap-bar-wrap" style="margin-top:6px"><div class="gap-track"><div class="gap-fill" style="width:${Math.min(100,r.lbl.includes('cobertura')&&!r.lbl.includes('D√≠as')?ratio/3*100:70)}%;background:${r.c};box-shadow:0 0 6px ${r.c}"></div></div></div>
    </div>`).join('');
}

/* ADD VENC */
function addVenc(){
  const tipo=document.getElementById('vTipo').value;
  const concepto=document.getElementById('vConcepto').value||'Vencimiento';
  const importe=parseFloat(document.getElementById('vImporte').value)||0;
  const fecha=document.getElementById('vFecha').value;
  const cuenta=document.getElementById('vCuenta').value;
  if(!fecha||importe===0){alert('Completa fecha e importe');return;}
  userVenc.push({tipo,concepto,importe,fecha,cuenta});
  userVenc.sort((a,b)=>a.fecha.localeCompare(b.fecha));
  renderAll();renderRecentVenc();
  document.getElementById('vConcepto').value='';document.getElementById('vImporte').value='';
}

function renderRecentVenc(){
  document.getElementById('recentVenc').innerHTML=[...userVenc].reverse().slice(0,6).map(vencHTML).join('')||'<div style="color:var(--muted);font-size:.8rem;padding:16px">Sin registros a√∫n</div>';
}

function renderAll(){renderKPIs();renderAlerts();renderFlowChart();renderNext30();}

/* INIT */
document.getElementById('vFecha').valueAsDate=addDays(today,7);
renderAll();
window.addEventListener('resize',()=>{renderFlowChart();});
</script>
</body>
</html>
